#include <main.h>
#include <device.h>
#include <stdlib.h>
#include <stdio.h>
#include <math.h>

//CY_ISR_PROTO(UART_RX_INTER);
CY_ISR_PROTO(TIMER_DMA_INTER);
CY_ISR_PROTO(DMA_FRAME_INTER);
void changeSPS(uint32 sps);

// Value describes sync state with PC GUI
uint8 initialized = 0;

// UART variables
char  rxBuffer[RX_BUFFER_SIZE];
uint8 rxBufLen     = 0;
uint8 commandReady = 0;
char  command[RX_BUFFER_SIZE];

// ADC Variables
uint8  adcOn           = 0;
uint   adcRez          = DEFAULT_ADC_RESOLUTION;
uint32 adcSPS          = DEFAULT_ADC_SPS;
uint8  adcFPS          = DEFAULT_ADC_FPS;
uint   adcFrameSize    = DEFAULT_ADC_FRAME_SIZE;
uint16 adcFrame[DEFAULT_ADC_FRAME_SIZE];
uint8  adcFrameReady    = 0;
uint32 adcSPSValues[6]  = {  50, 250, 1000, 50000, 250000, 1000000};
uint16 adcDiv8Bit[6]   = {  40,  40,   40,    40,     16,       4};
uint16 adcCount8Bit[6]  = {2000, 400,  100,     2,      1,       1};
uint16 adcDiv12Bit[6]   = {  26,  26,   26,    26,      5,       3};
uint16 adcCount12Bit[6] = {1000, 200,   50,     1,      1,       1};

// DAC Variables
uint8    dacOn       = 0;
uint32   dacFreq     = DEFAULT_DAC_FREQUENCY;
int16    dacVPP      = DEFAULT_DAC_VPP;
int16    dacOffset   = 0;
waveform dacWave     = DEFAULT_DAC_WAVE;
uint     dacDuty     = DEFAULT_DAC_DUTY;
uint     dacSample   = DEFAULT_DAC_SAMPLE_RATE;
uint16   sample_size = DEFAULT_DAC_SAMPLE_SIZE;
uint32   sample_rate = DEFAULT_DAC_SAMPLE_RATE;
char     wavetype    = 'Q';                      //Default waveform is Square

const uint8 sine[4000] = { 125u,125u,125u,126u,126u,126u,126u,126u,127u,127u,127u,127u,127u,128u,128u,128u,128u,128u,129u,129u,129u,129u,129u,130u,130u,130u,130u,130u,130u,131u,131u,131u,131u,131u,132u,132u,132u,132u,132u,133u,133u,133u,133u,133u,134u,134u,134u,134u,134u,135u,135u,135u,135u,135u,136u,136u,136u,136u,136u,137u,137u,137u,137u,137u,138u,138u,138u,138u,138u,139u,139u,139u,139u,139u,139u,140u,140u,140u,140u,140u,141u,141u,141u,141u,141u,142u,142u,142u,142u,142u,143u,143u,143u,143u,143u,144u,144u,144u,144u,144u,145u,145u,145u,145u,145u,146u,146u,146u,146u,146u,146u,147u,147u,147u,147u,147u,148u,148u,148u,148u,148u,149u,149u,149u,149u,149u,150u,150u,150u,150u,150u,151u,151u,151u,151u,151u,152u,152u,152u,152u,152u,152u,153u,153u,153u,153u,153u,154u,154u,154u,154u,154u,155u,155u,155u,155u,155u,156u,156u,156u,156u,156u,156u,157u,157u,157u,157u,157u,158u,158u,158u,158u,158u,159u,159u,159u,159u,159u,159u,160u,160u,160u,160u,160u,161u,161u,161u,161u,161u,162u,162u,162u,162u,162u,163u,163u,163u,163u,163u,163u,164u,164u,164u,164u,164u,165u,165u,165u,165u,165u,165u,166u,166u,166u,166u,166u,167u,167u,167u,167u,167u,168u,168u,168u,168u,168u,168u,169u,169u,169u,169u,169u,170u,170u,170u,170u,170u,170u,171u,171u,171u,171u,171u,172u,172u,172u,172u,172u,172u,173u,173u,173u,173u,173u,174u,174u,174u,174u,174u,174u,175u,175u,175u,175u,175u,176u,176u,176u,176u,176u,176u,177u,177u,177u,177u,177u,178u,178u,178u,178u,178u,178u,179u,179u,179u,179u,179u,179u,180u,180u,180u,180u,180u,181u,181u,181u,181u,181u,181u,182u,182u,182u,182u,182u,182u,183u,183u,183u,183u,183u,183u,184u,184u,184u,184u,184u,185u,185u,185u,185u,185u,185u,186u,186u,186u,186u,186u,186u,187u,187u,187u,187u,187u,187u,188u,188u,188u,188u,188u,188u,189u,189u,189u,189u,189u,189u,190u,190u,190u,190u,190u,190u,191u,191u,191u,191u,191u,191u,192u,192u,192u,192u,192u,192u,193u,193u,193u,193u,193u,193u,194u,194u,194u,194u,194u,194u,195u,195u,195u,195u,195u,195u,196u,196u,196u,196u,196u,196u,197u,197u,197u,197u,197u,197u,198u,198u,198u,198u,198u,198u,198u,199u,199u,199u,199u,199u,199u,200u,200u,200u,200u,200u,200u,201u,201u,201u,201u,201u,201u,201u,202u,202u,202u,202u,202u,202u,203u,203u,203u,203u,203u,203u,203u,204u,204u,204u,204u,204u,204u,205u,205u,205u,205u,205u,205u,205u,206u,206u,206u,206u,206u,206u,206u,207u,207u,207u,207u,207u,207u,208u,208u,208u,208u,208u,208u,208u,209u,209u,209u,209u,209u,209u,209u,210u,210u,210u,210u,210u,210u,210u,211u,211u,211u,211u,211u,211u,211u,212u,212u,212u,212u,212u,212u,212u,213u,213u,213u,213u,213u,213u,213u,214u,214u,214u,214u,214u,214u,214u,214u,215u,215u,215u,215u,215u,215u,215u,216u,216u,216u,216u,216u,216u,216u,217u,217u,217u,217u,217u,217u,217u,217u,218u,218u,218u,218u,218u,218u,218u,219u,219u,219u,219u,219u,219u,219u,219u,220u,220u,220u,220u,220u,220u,220u,220u,221u,221u,221u,221u,221u,221u,221u,221u,222u,222u,222u,222u,222u,222u,222u,222u,223u,223u,223u,223u,223u,223u,223u,223u,224u,224u,224u,224u,224u,224u,224u,224u,224u,225u,225u,225u,225u,225u,225u,225u,225u,226u,226u,226u,226u,226u,226u,226u,226u,226u,227u,227u,227u,227u,227u,227u,227u,227u,227u,228u,228u,228u,228u,228u,228u,228u,228u,228u,229u,229u,229u,229u,229u,229u,229u,229u,229u,230u,230u,230u,230u,230u,230u,230u,230u,230u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,250u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,230u,230u,230u,230u,230u,230u,230u,230u,230u,229u,229u,229u,229u,229u,229u,229u,229u,229u,228u,228u,228u,228u,228u,228u,228u,228u,228u,227u,227u,227u,227u,227u,227u,227u,227u,227u,226u,226u,226u,226u,226u,226u,226u,226u,226u,225u,225u,225u,225u,225u,225u,225u,225u,224u,224u,224u,224u,224u,224u,224u,224u,224u,223u,223u,223u,223u,223u,223u,223u,223u,222u,222u,222u,222u,222u,222u,222u,222u,221u,221u,221u,221u,221u,221u,221u,221u,220u,220u,220u,220u,220u,220u,220u,220u,219u,219u,219u,219u,219u,219u,219u,219u,218u,218u,218u,218u,218u,218u,218u,217u,217u,217u,217u,217u,217u,217u,217u,216u,216u,216u,216u,216u,216u,216u,215u,215u,215u,215u,215u,215u,215u,214u,214u,214u,214u,214u,214u,214u,214u,213u,213u,213u,213u,213u,213u,213u,212u,212u,212u,212u,212u,212u,212u,211u,211u,211u,211u,211u,211u,211u,210u,210u,210u,210u,210u,210u,210u,209u,209u,209u,209u,209u,209u,209u,208u,208u,208u,208u,208u,208u,208u,207u,207u,207u,207u,207u,207u,206u,206u,206u,206u,206u,206u,206u,205u,205u,205u,205u,205u,205u,205u,204u,204u,204u,204u,204u,204u,203u,203u,203u,203u,203u,203u,203u,202u,202u,202u,202u,202u,202u,201u,201u,201u,201u,201u,201u,201u,200u,200u,200u,200u,200u,200u,199u,199u,199u,199u,199u,199u,198u,198u,198u,198u,198u,198u,198u,197u,197u,197u,197u,197u,197u,196u,196u,196u,196u,196u,196u,195u,195u,195u,195u,195u,195u,194u,194u,194u,194u,194u,194u,193u,193u,193u,193u,193u,193u,192u,192u,192u,192u,192u,192u,191u,191u,191u,191u,191u,191u,190u,190u,190u,190u,190u,190u,189u,189u,189u,189u,189u,189u,188u,188u,188u,188u,188u,188u,187u,187u,187u,187u,187u,187u,186u,186u,186u,186u,186u,186u,185u,185u,185u,185u,185u,185u,184u,184u,184u,184u,184u,183u,183u,183u,183u,183u,183u,182u,182u,182u,182u,182u,182u,181u,181u,181u,181u,181u,181u,180u,180u,180u,180u,180u,179u,179u,179u,179u,179u,179u,178u,178u,178u,178u,178u,178u,177u,177u,177u,177u,177u,176u,176u,176u,176u,176u,176u,175u,175u,175u,175u,175u,174u,174u,174u,174u,174u,174u,173u,173u,173u,173u,173u,172u,172u,172u,172u,172u,172u,171u,171u,171u,171u,171u,170u,170u,170u,170u,170u,170u,169u,169u,169u,169u,169u,168u,168u,168u,168u,168u,168u,167u,167u,167u,167u,167u,166u,166u,166u,166u,166u,165u,165u,165u,165u,165u,165u,164u,164u,164u,164u,164u,163u,163u,163u,163u,163u,163u,162u,162u,162u,162u,162u,161u,161u,161u,161u,161u,160u,160u,160u,160u,160u,159u,159u,159u,159u,159u,159u,158u,158u,158u,158u,158u,157u,157u,157u,157u,157u,156u,156u,156u,156u,156u,156u,155u,155u,155u,155u,155u,154u,154u,154u,154u,154u,153u,153u,153u,153u,153u,152u,152u,152u,152u,152u,152u,151u,151u,151u,151u,151u,150u,150u,150u,150u,150u,149u,149u,149u,149u,149u,148u,148u,148u,148u,148u,147u,147u,147u,147u,147u,146u,146u,146u,146u,146u,146u,145u,145u,145u,145u,145u,144u,144u,144u,144u,144u,143u,143u,143u,143u,143u,142u,142u,142u,142u,142u,141u,141u,141u,141u,141u,140u,140u,140u,140u,140u,139u,139u,139u,139u,139u,139u,138u,138u,138u,138u,138u,137u,137u,137u,137u,137u,136u,136u,136u,136u,136u,135u,135u,135u,135u,135u,134u,134u,134u,134u,134u,133u,133u,133u,133u,133u,132u,132u,132u,132u,132u,131u,131u,131u,131u,131u,130u,130u,130u,130u,130u,130u,129u,129u,129u,129u,129u,128u,128u,128u,128u,128u,127u,127u,127u,127u,127u,126u,126u,126u,126u,126u,125u,125u,125u,125u,125u,124u,124u,124u,124u,124u,123u,123u,123u,123u,123u,122u,122u,122u,122u,122u,121u,121u,121u,121u,121u,120u,120u,120u,120u,120u,120u,119u,119u,119u,119u,119u,118u,118u,118u,118u,118u,117u,117u,117u,117u,117u,116u,116u,116u,116u,116u,115u,115u,115u,115u,115u,114u,114u,114u,114u,114u,113u,113u,113u,113u,113u,112u,112u,112u,112u,112u,111u,111u,111u,111u,111u,111u,110u,110u,110u,110u,110u,109u,109u,109u,109u,109u,108u,108u,108u,108u,108u,107u,107u,107u,107u,107u,106u,106u,106u,106u,106u,105u,105u,105u,105u,105u,104u,104u,104u,104u,104u,104u,103u,103u,103u,103u,103u,102u,102u,102u,102u,102u,101u,101u,101u,101u,101u,100u,100u,100u,100u,100u,99u,99u,99u,99u,99u,98u,98u,98u,98u,98u,98u,97u,97u,97u,97u,97u,96u,96u,96u,96u,96u,95u,95u,95u,95u,95u,94u,94u,94u,94u,94u,94u,93u,93u,93u,93u,93u,92u,92u,92u,92u,92u,91u,91u,91u,91u,91u,91u,90u,90u,90u,90u,90u,89u,89u,89u,89u,89u,88u,88u,88u,88u,88u,87u,87u,87u,87u,87u,87u,86u,86u,86u,86u,86u,85u,85u,85u,85u,85u,85u,84u,84u,84u,84u,84u,83u,83u,83u,83u,83u,82u,82u,82u,82u,82u,82u,81u,81u,81u,81u,81u,80u,80u,80u,80u,80u,80u,79u,79u,79u,79u,79u,78u,78u,78u,78u,78u,78u,77u,77u,77u,77u,77u,76u,76u,76u,76u,76u,76u,75u,75u,75u,75u,75u,74u,74u,74u,74u,74u,74u,73u,73u,73u,73u,73u,72u,72u,72u,72u,72u,72u,71u,71u,71u,71u,71u,71u,70u,70u,70u,70u,70u,69u,69u,69u,69u,69u,69u,68u,68u,68u,68u,68u,68u,67u,67u,67u,67u,67u,67u,66u,66u,66u,66u,66u,65u,65u,65u,65u,65u,65u,64u,64u,64u,64u,64u,64u,63u,63u,63u,63u,63u,63u,62u,62u,62u,62u,62u,62u,61u,61u,61u,61u,61u,61u,60u,60u,60u,60u,60u,60u,59u,59u,59u,59u,59u,59u,58u,58u,58u,58u,58u,58u,57u,57u,57u,57u,57u,57u,56u,56u,56u,56u,56u,56u,55u,55u,55u,55u,55u,55u,54u,54u,54u,54u,54u,54u,53u,53u,53u,53u,53u,53u,52u,52u,52u,52u,52u,52u,52u,51u,51u,51u,51u,51u,51u,50u,50u,50u,50u,50u,50u,49u,49u,49u,49u,49u,49u,49u,48u,48u,48u,48u,48u,48u,47u,47u,47u,47u,47u,47u,47u,46u,46u,46u,46u,46u,46u,45u,45u,45u,45u,45u,45u,45u,44u,44u,44u,44u,44u,44u,44u,43u,43u,43u,43u,43u,43u,42u,42u,42u,42u,42u,42u,42u,41u,41u,41u,41u,41u,41u,41u,40u,40u,40u,40u,40u,40u,40u,39u,39u,39u,39u,39u,39u,39u,38u,38u,38u,38u,38u,38u,38u,37u,37u,37u,37u,37u,37u,37u,36u,36u,36u,36u,36u,36u,36u,36u,35u,35u,35u,35u,35u,35u,35u,34u,34u,34u,34u,34u,34u,34u,33u,33u,33u,33u,33u,33u,33u,33u,32u,32u,32u,32u,32u,32u,32u,31u,31u,31u,31u,31u,31u,31u,31u,30u,30u,30u,30u,30u,30u,30u,30u,29u,29u,29u,29u,29u,29u,29u,29u,28u,28u,28u,28u,28u,28u,28u,28u,27u,27u,27u,27u,27u,27u,27u,27u,26u,26u,26u,26u,26u,26u,26u,26u,26u,25u,25u,25u,25u,25u,25u,25u,25u,24u,24u,24u,24u,24u,24u,24u,24u,24u,23u,23u,23u,23u,23u,23u,23u,23u,23u,22u,22u,22u,22u,22u,22u,22u,22u,22u,21u,21u,21u,21u,21u,21u,21u,21u,21u,20u,20u,20u,20u,20u,20u,20u,20u,20u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,0u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,20u,20u,20u,20u,20u,20u,20u,20u,20u,21u,21u,21u,21u,21u,21u,21u,21u,21u,22u,22u,22u,22u,22u,22u,22u,22u,22u,23u,23u,23u,23u,23u,23u,23u,23u,23u,24u,24u,24u,24u,24u,24u,24u,24u,24u,25u,25u,25u,25u,25u,25u,25u,25u,26u,26u,26u,26u,26u,26u,26u,26u,26u,27u,27u,27u,27u,27u,27u,27u,27u,28u,28u,28u,28u,28u,28u,28u,28u,29u,29u,29u,29u,29u,29u,29u,29u,30u,30u,30u,30u,30u,30u,30u,30u,31u,31u,31u,31u,31u,31u,31u,31u,32u,32u,32u,32u,32u,32u,32u,33u,33u,33u,33u,33u,33u,33u,33u,34u,34u,34u,34u,34u,34u,34u,35u,35u,35u,35u,35u,35u,35u,36u,36u,36u,36u,36u,36u,36u,36u,37u,37u,37u,37u,37u,37u,37u,38u,38u,38u,38u,38u,38u,38u,39u,39u,39u,39u,39u,39u,39u,40u,40u,40u,40u,40u,40u,40u,41u,41u,41u,41u,41u,41u,41u,42u,42u,42u,42u,42u,42u,42u,43u,43u,43u,43u,43u,43u,44u,44u,44u,44u,44u,44u,44u,45u,45u,45u,45u,45u,45u,45u,46u,46u,46u,46u,46u,46u,47u,47u,47u,47u,47u,47u,47u,48u,48u,48u,48u,48u,48u,49u,49u,49u,49u,49u,49u,49u,50u,50u,50u,50u,50u,50u,51u,51u,51u,51u,51u,51u,52u,52u,52u,52u,52u,52u,52u,53u,53u,53u,53u,53u,53u,54u,54u,54u,54u,54u,54u,55u,55u,55u,55u,55u,55u,56u,56u,56u,56u,56u,56u,57u,57u,57u,57u,57u,57u,58u,58u,58u,58u,58u,58u,59u,59u,59u,59u,59u,59u,60u,60u,60u,60u,60u,60u,61u,61u,61u,61u,61u,61u,62u,62u,62u,62u,62u,62u,63u,63u,63u,63u,63u,63u,64u,64u,64u,64u,64u,64u,65u,65u,65u,65u,65u,65u,66u,66u,66u,66u,66u,67u,67u,67u,67u,67u,67u,68u,68u,68u,68u,68u,68u,69u,69u,69u,69u,69u,69u,70u,70u,70u,70u,70u,71u,71u,71u,71u,71u,71u,72u,72u,72u,72u,72u,72u,73u,73u,73u,73u,73u,74u,74u,74u,74u,74u,74u,75u,75u,75u,75u,75u,76u,76u,76u,76u,76u,76u,77u,77u,77u,77u,77u,78u,78u,78u,78u,78u,78u,79u,79u,79u,79u,79u,80u,80u,80u,80u,80u,80u,81u,81u,81u,81u,81u,82u,82u,82u,82u,82u,82u,83u,83u,83u,83u,83u,84u,84u,84u,84u,84u,85u,85u,85u,85u,85u,85u,86u,86u,86u,86u,86u,87u,87u,87u,87u,87u,87u,88u,88u,88u,88u,88u,89u,89u,89u,89u,89u,90u,90u,90u,90u,90u,91u,91u,91u,91u,91u,91u,92u,92u,92u,92u,92u,93u,93u,93u,93u,93u,94u,94u,94u,94u,94u,94u,95u,95u,95u,95u,95u,96u,96u,96u,96u,96u,97u,97u,97u,97u,97u,98u,98u,98u,98u,98u,98u,99u,99u,99u,99u,99u,100u,100u,100u,100u,100u,101u,101u,101u,101u,101u,102u,102u,102u,102u,102u,103u,103u,103u,103u,103u,104u,104u,104u,104u,104u,104u,105u,105u,105u,105u,105u,106u,106u,106u,106u,106u,107u,107u,107u,107u,107u,108u,108u,108u,108u,108u,109u,109u,109u,109u,109u,110u,110u,110u,110u,110u,111u,111u,111u,111u,111u,111u,112u,112u,112u,112u,112u,113u,113u,113u,113u,113u,114u,114u,114u,114u,114u,115u,115u,115u,115u,115u,116u,116u,116u,116u,116u,117u,117u,117u,117u,117u,118u,118u,118u,118u,118u,119u,119u,119u,119u,119u,120u,120u,120u,120u,120u,120u,121u,121u,121u,121u,121u,122u,122u,122u,122u,122u,123u,123u,123u,123u,123u,124u,124u,124u,124u,124u,125u,125u };
const uint8 triangle[4000] = { 125u,125u,125u,125u,126u,126u,126u,126u,126u,126u,126u,126u,126u,127u,127u,127u,127u,127u,127u,127u,128u,128u,128u,128u,128u,128u,128u,128u,128u,129u,129u,129u,129u,129u,129u,129u,130u,130u,130u,130u,130u,130u,130u,130u,130u,131u,131u,131u,131u,131u,131u,131u,132u,132u,132u,132u,132u,132u,132u,132u,132u,133u,133u,133u,133u,133u,133u,133u,134u,134u,134u,134u,134u,134u,134u,134u,134u,135u,135u,135u,135u,135u,135u,135u,136u,136u,136u,136u,136u,136u,136u,136u,136u,137u,137u,137u,137u,137u,137u,137u,138u,138u,138u,138u,138u,138u,138u,138u,138u,139u,139u,139u,139u,139u,139u,139u,140u,140u,140u,140u,140u,140u,140u,140u,140u,141u,141u,141u,141u,141u,141u,141u,142u,142u,142u,142u,142u,142u,142u,142u,143u,143u,143u,143u,143u,143u,143u,143u,144u,144u,144u,144u,144u,144u,144u,144u,144u,145u,145u,145u,145u,145u,145u,145u,146u,146u,146u,146u,146u,146u,146u,146u,146u,147u,147u,147u,147u,147u,147u,147u,148u,148u,148u,148u,148u,148u,148u,148u,148u,149u,149u,149u,149u,149u,149u,149u,150u,150u,150u,150u,150u,150u,150u,150u,150u,151u,151u,151u,151u,151u,151u,151u,152u,152u,152u,152u,152u,152u,152u,152u,152u,153u,153u,153u,153u,153u,153u,153u,154u,154u,154u,154u,154u,154u,154u,154u,154u,155u,155u,155u,155u,155u,155u,155u,156u,156u,156u,156u,156u,156u,156u,156u,156u,157u,157u,157u,157u,157u,157u,157u,158u,158u,158u,158u,158u,158u,158u,158u,158u,159u,159u,159u,159u,159u,159u,159u,160u,160u,160u,160u,160u,160u,160u,160u,160u,161u,161u,161u,161u,161u,161u,161u,162u,162u,162u,162u,162u,162u,162u,162u,162u,163u,163u,163u,163u,163u,163u,163u,164u,164u,164u,164u,164u,164u,164u,164u,164u,165u,165u,165u,165u,165u,165u,165u,166u,166u,166u,166u,166u,166u,166u,166u,166u,167u,167u,167u,167u,167u,167u,167u,168u,168u,168u,168u,168u,168u,168u,168u,168u,169u,169u,169u,169u,169u,169u,169u,169u,170u,170u,170u,170u,170u,170u,170u,170u,171u,171u,171u,171u,171u,171u,171u,172u,172u,172u,172u,172u,172u,172u,172u,172u,173u,173u,173u,173u,173u,173u,173u,174u,174u,174u,174u,174u,174u,174u,174u,174u,175u,175u,175u,175u,175u,175u,175u,176u,176u,176u,176u,176u,176u,176u,176u,176u,177u,177u,177u,177u,177u,177u,177u,178u,178u,178u,178u,178u,178u,178u,178u,178u,179u,179u,179u,179u,179u,179u,179u,180u,180u,180u,180u,180u,180u,180u,180u,180u,181u,181u,181u,181u,181u,181u,181u,182u,182u,182u,182u,182u,182u,182u,182u,182u,183u,183u,183u,183u,183u,183u,183u,184u,184u,184u,184u,184u,184u,184u,184u,184u,185u,185u,185u,185u,185u,185u,185u,186u,186u,186u,186u,186u,186u,186u,186u,186u,187u,187u,187u,187u,187u,187u,187u,188u,188u,188u,188u,188u,188u,188u,188u,188u,189u,189u,189u,189u,189u,189u,189u,190u,190u,190u,190u,190u,190u,190u,190u,190u,191u,191u,191u,191u,191u,191u,191u,192u,192u,192u,192u,192u,192u,192u,192u,192u,193u,193u,193u,193u,193u,193u,193u,194u,194u,194u,194u,194u,194u,194u,194u,194u,195u,195u,195u,195u,195u,195u,195u,196u,196u,196u,196u,196u,196u,196u,196u,196u,197u,197u,197u,197u,197u,197u,197u,198u,198u,198u,198u,198u,198u,198u,198u,198u,199u,199u,199u,199u,199u,199u,199u,200u,200u,200u,200u,200u,200u,200u,200u,200u,201u,201u,201u,201u,201u,201u,201u,202u,202u,202u,202u,202u,202u,202u,202u,202u,203u,203u,203u,203u,203u,203u,203u,204u,204u,204u,204u,204u,204u,204u,204u,205u,205u,205u,205u,205u,205u,205u,205u,206u,206u,206u,206u,206u,206u,206u,206u,207u,207u,207u,207u,207u,207u,207u,207u,208u,208u,208u,208u,208u,208u,208u,208u,209u,209u,209u,209u,209u,209u,209u,209u,210u,210u,210u,210u,210u,210u,210u,210u,211u,211u,211u,211u,211u,211u,211u,211u,212u,212u,212u,212u,212u,212u,212u,212u,212u,213u,213u,213u,213u,213u,213u,213u,214u,214u,214u,214u,214u,214u,214u,214u,214u,215u,215u,215u,215u,215u,215u,215u,216u,216u,216u,216u,216u,216u,216u,216u,216u,217u,217u,217u,217u,217u,217u,217u,218u,218u,218u,218u,218u,218u,218u,218u,218u,219u,219u,219u,219u,219u,219u,219u,220u,220u,220u,220u,220u,220u,220u,220u,220u,221u,221u,221u,221u,221u,221u,221u,222u,222u,222u,222u,222u,222u,222u,222u,222u,223u,223u,223u,223u,223u,223u,223u,224u,224u,224u,224u,224u,224u,224u,224u,224u,225u,225u,225u,225u,225u,225u,225u,226u,226u,226u,226u,226u,226u,226u,226u,226u,227u,227u,227u,227u,227u,227u,227u,227u,228u,228u,228u,228u,228u,228u,228u,228u,229u,229u,229u,229u,229u,229u,229u,229u,230u,230u,230u,230u,230u,230u,230u,230u,231u,231u,231u,231u,231u,231u,231u,231u,232u,232u,232u,232u,232u,232u,232u,232u,233u,233u,233u,233u,233u,233u,233u,233u,234u,234u,234u,234u,234u,234u,234u,234u,235u,235u,235u,235u,235u,235u,235u,236u,236u,236u,236u,236u,236u,236u,236u,236u,237u,237u,237u,237u,237u,237u,237u,238u,238u,238u,238u,238u,238u,238u,238u,238u,239u,239u,239u,239u,239u,239u,239u,240u,240u,240u,240u,240u,240u,240u,240u,240u,241u,241u,241u,241u,241u,241u,241u,242u,242u,242u,242u,242u,242u,242u,242u,242u,243u,243u,243u,243u,243u,243u,243u,244u,244u,244u,244u,244u,244u,244u,244u,244u,245u,245u,245u,245u,245u,245u,245u,246u,246u,246u,246u,246u,246u,246u,246u,246u,247u,247u,247u,247u,247u,247u,247u,248u,248u,248u,248u,248u,248u,248u,248u,248u,249u,249u,249u,249u,249u,249u,249u,250u,250u,250u,250u,250u,250u,250u,250u,250u,249u,249u,249u,249u,249u,249u,249u,248u,248u,248u,248u,248u,248u,248u,248u,248u,247u,247u,247u,247u,247u,247u,247u,246u,246u,246u,246u,246u,246u,246u,246u,246u,245u,245u,245u,245u,245u,245u,245u,244u,244u,244u,244u,244u,244u,244u,244u,244u,243u,243u,243u,243u,243u,243u,243u,242u,242u,242u,242u,242u,242u,242u,242u,242u,241u,241u,241u,241u,241u,241u,241u,240u,240u,240u,240u,240u,240u,240u,240u,240u,239u,239u,239u,239u,239u,239u,239u,238u,238u,238u,238u,238u,238u,238u,238u,238u,237u,237u,237u,237u,237u,237u,237u,236u,236u,236u,236u,236u,236u,236u,236u,236u,235u,235u,235u,235u,235u,235u,235u,234u,234u,234u,234u,234u,234u,234u,234u,234u,233u,233u,233u,233u,233u,233u,233u,232u,232u,232u,232u,232u,232u,232u,232u,232u,231u,231u,231u,231u,231u,231u,231u,230u,230u,230u,230u,230u,230u,230u,230u,230u,229u,229u,229u,229u,229u,229u,229u,228u,228u,228u,228u,228u,228u,228u,228u,228u,227u,227u,227u,227u,227u,227u,227u,226u,226u,226u,226u,226u,226u,226u,226u,226u,225u,225u,225u,225u,225u,225u,225u,224u,224u,224u,224u,224u,224u,224u,224u,224u,223u,223u,223u,223u,223u,223u,223u,222u,222u,222u,222u,222u,222u,222u,222u,222u,221u,221u,221u,221u,221u,221u,221u,220u,220u,220u,220u,220u,220u,220u,220u,220u,219u,219u,219u,219u,219u,219u,219u,218u,218u,218u,218u,218u,218u,218u,218u,218u,217u,217u,217u,217u,217u,217u,217u,216u,216u,216u,216u,216u,216u,216u,216u,216u,215u,215u,215u,215u,215u,215u,215u,214u,214u,214u,214u,214u,214u,214u,214u,214u,213u,213u,213u,213u,213u,213u,213u,212u,212u,212u,212u,212u,212u,212u,212u,212u,211u,211u,211u,211u,211u,211u,211u,210u,210u,210u,210u,210u,210u,210u,210u,210u,209u,209u,209u,209u,209u,209u,209u,208u,208u,208u,208u,208u,208u,208u,208u,208u,207u,207u,207u,207u,207u,207u,207u,206u,206u,206u,206u,206u,206u,206u,206u,206u,205u,205u,205u,205u,205u,205u,205u,204u,204u,204u,204u,204u,204u,204u,204u,204u,203u,203u,203u,203u,203u,203u,203u,202u,202u,202u,202u,202u,202u,202u,202u,202u,201u,201u,201u,201u,201u,201u,201u,200u,200u,200u,200u,200u,200u,200u,200u,200u,199u,199u,199u,199u,199u,199u,199u,198u,198u,198u,198u,198u,198u,198u,198u,198u,197u,197u,197u,197u,197u,197u,197u,196u,196u,196u,196u,196u,196u,196u,196u,196u,195u,195u,195u,195u,195u,195u,195u,194u,194u,194u,194u,194u,194u,194u,194u,194u,193u,193u,193u,193u,193u,193u,193u,192u,192u,192u,192u,192u,192u,192u,192u,192u,191u,191u,191u,191u,191u,191u,191u,190u,190u,190u,190u,190u,190u,190u,190u,190u,189u,189u,189u,189u,189u,189u,189u,188u,188u,188u,188u,188u,188u,188u,188u,188u,187u,187u,187u,187u,187u,187u,187u,186u,186u,186u,186u,186u,186u,186u,186u,186u,185u,185u,185u,185u,185u,185u,185u,184u,184u,184u,184u,184u,184u,184u,184u,184u,183u,183u,183u,183u,183u,183u,183u,182u,182u,182u,182u,182u,182u,182u,182u,182u,181u,181u,181u,181u,181u,181u,181u,180u,180u,180u,180u,180u,180u,180u,180u,180u,179u,179u,179u,179u,179u,179u,179u,178u,178u,178u,178u,178u,178u,178u,178u,178u,177u,177u,177u,177u,177u,177u,177u,176u,176u,176u,176u,176u,176u,176u,176u,176u,175u,175u,175u,175u,175u,175u,175u,174u,174u,174u,174u,174u,174u,174u,174u,174u,173u,173u,173u,173u,173u,173u,173u,172u,172u,172u,172u,172u,172u,172u,172u,172u,171u,171u,171u,171u,171u,171u,171u,170u,170u,170u,170u,170u,170u,170u,170u,170u,169u,169u,169u,169u,169u,169u,169u,168u,168u,168u,168u,168u,168u,168u,168u,168u,167u,167u,167u,167u,167u,167u,167u,166u,166u,166u,166u,166u,166u,166u,166u,166u,165u,165u,165u,165u,165u,165u,165u,164u,164u,164u,164u,164u,164u,164u,164u,164u,163u,163u,163u,163u,163u,163u,163u,162u,162u,162u,162u,162u,162u,162u,162u,162u,161u,161u,161u,161u,161u,161u,161u,160u,160u,160u,160u,160u,160u,160u,160u,160u,159u,159u,159u,159u,159u,159u,159u,158u,158u,158u,158u,158u,158u,158u,158u,158u,157u,157u,157u,157u,157u,157u,157u,156u,156u,156u,156u,156u,156u,156u,156u,156u,155u,155u,155u,155u,155u,155u,155u,154u,154u,154u,154u,154u,154u,154u,154u,154u,153u,153u,153u,153u,153u,153u,153u,152u,152u,152u,152u,152u,152u,152u,152u,152u,151u,151u,151u,151u,151u,151u,151u,150u,150u,150u,150u,150u,150u,150u,150u,150u,149u,149u,149u,149u,149u,149u,149u,148u,148u,148u,148u,148u,148u,148u,148u,148u,147u,147u,147u,147u,147u,147u,147u,146u,146u,146u,146u,146u,146u,146u,146u,146u,145u,145u,145u,145u,145u,145u,145u,144u,144u,144u,144u,144u,144u,144u,144u,144u,143u,143u,143u,143u,143u,143u,143u,142u,142u,142u,142u,142u,142u,142u,142u,142u,141u,141u,141u,141u,141u,141u,141u,140u,140u,140u,140u,140u,140u,140u,140u,140u,139u,139u,139u,139u,139u,139u,139u,138u,138u,138u,138u,138u,138u,138u,138u,138u,137u,137u,137u,137u,137u,137u,137u,136u,136u,136u,136u,136u,136u,136u,136u,136u,135u,135u,135u,135u,135u,135u,135u,134u,134u,134u,134u,134u,134u,134u,134u,134u,133u,133u,133u,133u,133u,133u,133u,132u,132u,132u,132u,132u,132u,132u,132u,132u,131u,131u,131u,131u,131u,131u,131u,130u,130u,130u,130u,130u,130u,130u,130u,130u,129u,129u,129u,129u,129u,129u,129u,128u,128u,128u,128u,128u,128u,128u,128u,128u,127u,127u,127u,127u,127u,127u,127u,126u,126u,126u,126u,126u,126u,126u,126u,126u,125u,125u,125u,125u,125u,125u,125u,124u,124u,124u,124u,124u,124u,124u,124u,124u,123u,123u,123u,123u,123u,123u,123u,122u,122u,122u,122u,122u,122u,122u,122u,122u,121u,121u,121u,121u,121u,121u,121u,120u,120u,120u,120u,120u,120u,120u,120u,120u,119u,119u,119u,119u,119u,119u,119u,118u,118u,118u,118u,118u,118u,118u,118u,118u,117u,117u,117u,117u,117u,117u,117u,116u,116u,116u,116u,116u,116u,116u,116u,115u,115u,115u,115u,115u,115u,115u,115u,114u,114u,114u,114u,114u,114u,114u,114u,113u,113u,113u,113u,113u,113u,113u,113u,112u,112u,112u,112u,112u,112u,112u,112u,111u,111u,111u,111u,111u,111u,111u,111u,110u,110u,110u,110u,110u,110u,110u,110u,109u,109u,109u,109u,109u,109u,109u,109u,108u,108u,108u,108u,108u,108u,108u,108u,107u,107u,107u,107u,107u,107u,107u,107u,106u,106u,106u,106u,106u,106u,106u,106u,105u,105u,105u,105u,105u,105u,105u,105u,104u,104u,104u,104u,104u,104u,104u,104u,103u,103u,103u,103u,103u,103u,103u,103u,102u,102u,102u,102u,102u,102u,102u,102u,101u,101u,101u,101u,101u,101u,101u,101u,100u,100u,100u,100u,100u,100u,100u,100u,99u,99u,99u,99u,99u,99u,99u,99u,98u,98u,98u,98u,98u,98u,98u,98u,97u,97u,97u,97u,97u,97u,97u,97u,96u,96u,96u,96u,96u,96u,96u,96u,95u,95u,95u,95u,95u,95u,95u,95u,94u,94u,94u,94u,94u,94u,94u,94u,94u,93u,93u,93u,93u,93u,93u,93u,93u,92u,92u,92u,92u,92u,92u,92u,92u,91u,91u,91u,91u,91u,91u,91u,91u,90u,90u,90u,90u,90u,90u,90u,90u,89u,89u,89u,89u,89u,89u,89u,89u,88u,88u,88u,88u,88u,88u,88u,88u,87u,87u,87u,87u,87u,87u,87u,87u,86u,86u,86u,86u,86u,86u,86u,86u,85u,85u,85u,85u,85u,85u,85u,85u,84u,84u,84u,84u,84u,84u,84u,84u,83u,83u,83u,83u,83u,83u,83u,83u,82u,82u,82u,82u,82u,82u,82u,82u,81u,81u,81u,81u,81u,81u,81u,81u,80u,80u,80u,80u,80u,80u,80u,80u,79u,79u,79u,79u,79u,79u,79u,79u,78u,78u,78u,78u,78u,78u,78u,78u,77u,77u,77u,77u,77u,77u,77u,77u,76u,76u,76u,76u,76u,76u,76u,76u,75u,75u,75u,75u,75u,75u,75u,75u,74u,74u,74u,74u,74u,74u,74u,74u,73u,73u,73u,73u,73u,73u,73u,73u,72u,72u,72u,72u,72u,72u,72u,72u,71u,71u,71u,71u,71u,71u,71u,70u,70u,70u,70u,70u,70u,70u,70u,70u,69u,69u,69u,69u,69u,69u,69u,68u,68u,68u,68u,68u,68u,68u,68u,68u,67u,67u,67u,67u,67u,67u,67u,66u,66u,66u,66u,66u,66u,66u,66u,66u,65u,65u,65u,65u,65u,65u,65u,64u,64u,64u,64u,64u,64u,64u,64u,64u,63u,63u,63u,63u,63u,63u,63u,62u,62u,62u,62u,62u,62u,62u,62u,62u,61u,61u,61u,61u,61u,61u,61u,60u,60u,60u,60u,60u,60u,60u,60u,60u,59u,59u,59u,59u,59u,59u,59u,58u,58u,58u,58u,58u,58u,58u,58u,57u,57u,57u,57u,57u,57u,57u,57u,56u,56u,56u,56u,56u,56u,56u,56u,55u,55u,55u,55u,55u,55u,55u,55u,54u,54u,54u,54u,54u,54u,54u,54u,53u,53u,53u,53u,53u,53u,53u,53u,52u,52u,52u,52u,52u,52u,52u,52u,51u,51u,51u,51u,51u,51u,51u,51u,50u,50u,50u,50u,50u,50u,50u,50u,49u,49u,49u,49u,49u,49u,49u,49u,48u,48u,48u,48u,48u,48u,48u,48u,47u,47u,47u,47u,47u,47u,47u,47u,46u,46u,46u,46u,46u,46u,46u,46u,45u,45u,45u,45u,45u,45u,45u,45u,44u,44u,44u,44u,44u,44u,44u,44u,43u,43u,43u,43u,43u,43u,43u,43u,42u,42u,42u,42u,42u,42u,42u,42u,41u,41u,41u,41u,41u,41u,41u,41u,40u,40u,40u,40u,40u,40u,40u,40u,39u,39u,39u,39u,39u,39u,39u,39u,38u,38u,38u,38u,38u,38u,38u,38u,37u,37u,37u,37u,37u,37u,37u,37u,36u,36u,36u,36u,36u,36u,36u,36u,35u,35u,35u,35u,35u,35u,35u,35u,34u,34u,34u,34u,34u,34u,34u,34u,33u,33u,33u,33u,33u,33u,33u,33u,32u,32u,32u,32u,32u,32u,32u,32u,31u,31u,31u,31u,31u,31u,31u,31u,31u,30u,30u,30u,30u,30u,30u,30u,30u,29u,29u,29u,29u,29u,29u,29u,29u,28u,28u,28u,28u,28u,28u,28u,28u,27u,27u,27u,27u,27u,27u,27u,27u,26u,26u,26u,26u,26u,26u,26u,26u,25u,25u,25u,25u,25u,25u,25u,25u,24u,24u,24u,24u,24u,24u,24u,24u,23u,23u,23u,23u,23u,23u,23u,23u,22u,22u,22u,22u,22u,22u,22u,22u,21u,21u,21u,21u,21u,21u,21u,21u,20u,20u,20u,20u,20u,20u,20u,20u,19u,19u,19u,19u,19u,19u,19u,19u,18u,18u,18u,18u,18u,18u,18u,18u,17u,17u,17u,17u,17u,17u,17u,17u,16u,16u,16u,16u,16u,16u,16u,16u,15u,15u,15u,15u,15u,15u,15u,15u,14u,14u,14u,14u,14u,14u,14u,14u,13u,13u,13u,13u,13u,13u,13u,13u,12u,12u,12u,12u,12u,12u,12u,12u,11u,11u,11u,11u,11u,11u,11u,11u,10u,10u,10u,10u,10u,10u,10u,10u,9u,9u,9u,9u,9u,9u,9u,9u,8u,8u,8u,8u,8u,8u,8u,8u,7u,7u,7u,7u,7u,7u,7u,7u,6u,6u,6u,6u,6u,6u,6u,6u,5u,5u,5u,5u,5u,5u,5u,5u,4u,4u,4u,4u,4u,4u,4u,4u,3u,3u,3u,3u,3u,3u,3u,3u,2u,2u,2u,2u,2u,2u,2u,2u,1u,1u,1u,1u,1u,1u,1u,1u,0u,0u,0u,0u,0u,0u,0u,1u,1u,1u,1u,1u,1u,1u,1u,2u,2u,2u,2u,2u,2u,2u,2u,3u,3u,3u,3u,3u,3u,3u,3u,4u,4u,4u,4u,4u,4u,4u,4u,5u,5u,5u,5u,5u,5u,5u,5u,6u,6u,6u,6u,6u,6u,6u,6u,7u,7u,7u,7u,7u,7u,7u,7u,8u,8u,8u,8u,8u,8u,8u,8u,9u,9u,9u,9u,9u,9u,9u,9u,10u,10u,10u,10u,10u,10u,10u,10u,11u,11u,11u,11u,11u,11u,11u,11u,12u,12u,12u,12u,12u,12u,12u,12u,13u,13u,13u,13u,13u,13u,13u,13u,14u,14u,14u,14u,14u,14u,14u,14u,15u,15u,15u,15u,15u,15u,15u,15u,16u,16u,16u,16u,16u,16u,16u,16u,17u,17u,17u,17u,17u,17u,17u,17u,18u,18u,18u,18u,18u,18u,18u,18u,19u,19u,19u,19u,19u,19u,19u,19u,20u,20u,20u,20u,20u,20u,20u,20u,21u,21u,21u,21u,21u,21u,21u,21u,22u,22u,22u,22u,22u,22u,22u,22u,23u,23u,23u,23u,23u,23u,23u,23u,24u,24u,24u,24u,24u,24u,24u,24u,25u,25u,25u,25u,25u,25u,25u,25u,26u,26u,26u,26u,26u,26u,26u,26u,27u,27u,27u,27u,27u,27u,27u,27u,28u,28u,28u,28u,28u,28u,28u,28u,29u,29u,29u,29u,29u,29u,29u,29u,30u,30u,30u,30u,30u,30u,30u,30u,31u,31u,31u,31u,31u,31u,31u,31u,31u,32u,32u,32u,32u,32u,32u,32u,32u,33u,33u,33u,33u,33u,33u,33u,33u,34u,34u,34u,34u,34u,34u,34u,34u,35u,35u,35u,35u,35u,35u,35u,35u,36u,36u,36u,36u,36u,36u,36u,36u,37u,37u,37u,37u,37u,37u,37u,37u,38u,38u,38u,38u,38u,38u,38u,38u,39u,39u,39u,39u,39u,39u,39u,39u,40u,40u,40u,40u,40u,40u,40u,40u,41u,41u,41u,41u,41u,41u,41u,41u,42u,42u,42u,42u,42u,42u,42u,42u,43u,43u,43u,43u,43u,43u,43u,43u,44u,44u,44u,44u,44u,44u,44u,44u,45u,45u,45u,45u,45u,45u,45u,45u,46u,46u,46u,46u,46u,46u,46u,46u,47u,47u,47u,47u,47u,47u,47u,47u,48u,48u,48u,48u,48u,48u,48u,48u,49u,49u,49u,49u,49u,49u,49u,49u,50u,50u,50u,50u,50u,50u,50u,50u,51u,51u,51u,51u,51u,51u,51u,51u,52u,52u,52u,52u,52u,52u,52u,52u,53u,53u,53u,53u,53u,53u,53u,53u,54u,54u,54u,54u,54u,54u,54u,54u,55u,55u,55u,55u,55u,55u,55u,55u,56u,56u,56u,56u,56u,56u,56u,56u,57u,57u,57u,57u,57u,57u,57u,57u,58u,58u,58u,58u,58u,58u,58u,58u,59u,59u,59u,59u,59u,59u,59u,60u,60u,60u,60u,60u,60u,60u,60u,60u,61u,61u,61u,61u,61u,61u,61u,62u,62u,62u,62u,62u,62u,62u,62u,62u,63u,63u,63u,63u,63u,63u,63u,64u,64u,64u,64u,64u,64u,64u,64u,64u,65u,65u,65u,65u,65u,65u,65u,66u,66u,66u,66u,66u,66u,66u,66u,66u,67u,67u,67u,67u,67u,67u,67u,68u,68u,68u,68u,68u,68u,68u,68u,68u,69u,69u,69u,69u,69u,69u,69u,70u,70u,70u,70u,70u,70u,70u,70u,70u,71u,71u,71u,71u,71u,71u,71u,72u,72u,72u,72u,72u,72u,72u,72u,73u,73u,73u,73u,73u,73u,73u,73u,74u,74u,74u,74u,74u,74u,74u,74u,75u,75u,75u,75u,75u,75u,75u,75u,76u,76u,76u,76u,76u,76u,76u,76u,77u,77u,77u,77u,77u,77u,77u,77u,78u,78u,78u,78u,78u,78u,78u,78u,79u,79u,79u,79u,79u,79u,79u,79u,80u,80u,80u,80u,80u,80u,80u,80u,81u,81u,81u,81u,81u,81u,81u,81u,82u,82u,82u,82u,82u,82u,82u,82u,83u,83u,83u,83u,83u,83u,83u,83u,84u,84u,84u,84u,84u,84u,84u,84u,85u,85u,85u,85u,85u,85u,85u,85u,86u,86u,86u,86u,86u,86u,86u,86u,87u,87u,87u,87u,87u,87u,87u,87u,88u,88u,88u,88u,88u,88u,88u,88u,89u,89u,89u,89u,89u,89u,89u,89u,90u,90u,90u,90u,90u,90u,90u,90u,91u,91u,91u,91u,91u,91u,91u,91u,92u,92u,92u,92u,92u,92u,92u,92u,93u,93u,93u,93u,93u,93u,93u,93u,94u,94u,94u,94u,94u,94u,94u,94u,94u,95u,95u,95u,95u,95u,95u,95u,95u,96u,96u,96u,96u,96u,96u,96u,96u,97u,97u,97u,97u,97u,97u,97u,97u,98u,98u,98u,98u,98u,98u,98u,98u,99u,99u,99u,99u,99u,99u,99u,99u,100u,100u,100u,100u,100u,100u,100u,100u,101u,101u,101u,101u,101u,101u,101u,101u,102u,102u,102u,102u,102u,102u,102u,102u,103u,103u,103u,103u,103u,103u,103u,103u,104u,104u,104u,104u,104u,104u,104u,104u,105u,105u,105u,105u,105u,105u,105u,105u,106u,106u,106u,106u,106u,106u,106u,106u,107u,107u,107u,107u,107u,107u,107u,107u,108u,108u,108u,108u,108u,108u,108u,108u,109u,109u,109u,109u,109u,109u,109u,109u,110u,110u,110u,110u,110u,110u,110u,110u,111u,111u,111u,111u,111u,111u,111u,111u,112u,112u,112u,112u,112u,112u,112u,112u,113u,113u,113u,113u,113u,113u,113u,113u,114u,114u,114u,114u,114u,114u,114u,114u,115u,115u,115u,115u,115u,115u,115u,115u,116u,116u,116u,116u,116u,116u,116u,116u,117u,117u,117u,117u,117u,117u,117u,118u,118u,118u,118u,118u,118u,118u,118u,118u,119u,119u,119u,119u,119u,119u,119u,120u,120u,120u,120u,120u,120u,120u,120u,120u,121u,121u,121u,121u,121u,121u,121u,122u,122u,122u,122u,122u,122u,122u,122u,122u,123u,123u,123u,123u,123u,123u,123u,124u,124u,124u,124u,124u,124u,124u,124u,124u,125u,125u,125u };
const uint8 sawtooth[4000] = { 0u,0u,0u,0u,0u,0u,0u,0u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,1u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,2u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,3u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,4u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,5u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,6u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,7u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,8u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,9u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,10u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,11u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,12u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,13u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,14u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,15u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,16u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,17u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,18u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,19u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,20u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,21u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,22u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,23u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,24u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,25u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,26u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,27u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,28u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,29u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,30u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,31u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,32u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,33u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,34u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,35u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,36u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,37u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,38u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,39u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,40u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,41u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,42u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,43u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,44u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,45u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,46u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,47u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,48u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,49u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,50u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,51u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,52u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,53u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,54u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,55u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,56u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,57u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,58u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,59u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,60u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,61u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,62u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,63u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,64u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,65u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,66u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,67u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,68u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,69u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,70u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,71u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,72u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,73u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,74u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,75u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,76u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,77u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,78u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,79u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,80u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,81u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,82u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,83u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,84u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,85u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,86u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,87u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,88u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,89u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,90u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,91u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,92u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,93u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,94u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,95u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,96u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,97u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,98u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,99u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,100u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,101u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,102u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,103u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,104u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,105u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,106u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,107u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,108u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,109u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,110u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,111u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,112u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,113u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,114u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,115u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,116u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,117u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,118u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,119u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,120u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,121u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,122u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,123u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,124u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,125u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,126u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,127u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,128u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,129u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,130u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,131u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,132u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,133u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,134u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,135u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,136u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,137u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,138u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,139u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,140u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,141u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,142u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,143u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,144u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,145u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,146u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,147u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,148u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,149u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,150u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,151u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,152u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,153u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,154u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,155u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,156u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,157u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,158u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,159u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,160u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,161u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,162u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,163u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,164u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,165u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,166u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,167u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,168u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,169u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,170u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,171u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,172u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,173u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,174u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,175u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,176u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,177u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,178u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,179u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,180u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,181u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,182u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,183u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,184u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,185u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,186u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,187u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,188u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,189u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,190u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,191u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,192u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,193u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,194u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,195u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,196u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,197u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,198u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,199u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,200u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,201u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,202u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,203u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,204u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,205u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,206u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,207u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,208u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,209u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,210u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,211u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,212u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,213u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,214u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,215u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,216u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,217u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,218u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,219u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,220u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,221u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,222u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,223u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,224u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,225u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,226u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,227u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,228u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,229u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,230u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,231u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,232u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,233u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,234u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,235u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,236u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,237u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,238u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,239u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,240u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,241u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,242u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,243u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,244u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,245u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,246u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,247u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,248u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,249u,250u,250u,250u,250u,250u,250u,250u,250u };
uint8_t wave[4000];

/* Variable declarations for DMA_ADC_MEM */
uint8 DMA_ADC_MEM_Chan;
uint8 DMA_ADC_MEM_TD[1];

int main() {
    uint16 i;
    char framePrefix[10];
    
    // Init modules
    //adcFrame = malloc(adcFrameSize);
    UART_Start();
    ADC_Start();
    
    DMA_ADC_MEM_Config();
    TIMER_DMA_Init();
    SPS_Divider_Counter_Start();
    //UART_RX_StartEx(UART_RX_INTER);
    DMA_ENABLE_StartEx(TIMER_DMA_INTER);
    DMA_FRAME_READY_StartEx(DMA_FRAME_INTER);
    CYGlobalIntEnable;
    
    for/*ever*/(;;) {
        // Sync with the GUI
        while(!initialized) {
            if (commandReady) {
                commandReady = 0;
                if (strcmp(command, PC_CONNECT) == 0) {
                    initialized = 1;
                    UART_PutString(PSOC_ACK);
                }
            }
        }
        
        // Send ADC frame to PC if available
        if (adcFrameReady) {
            //sprintf(framePrefix, "#F%dK%luD", adcFrameSize, adcSPS);
            sprintf(framePrefix, "#F%dD", adcFrameSize); // **** Change back after revision
            UART_PutString(framePrefix);
            //for (i = 0; i < adcFrameSize; i++) {
                #ifndef DEBUG_OUTPUT
                UART_PutArray((uint8*)adcFrame, 2 * adcFrameSize);
                //UART_PutChar((adcFrame[i] >> 8) & 0x0F);
                //UART_PutChar(adcFrame[i] & 0XFF);
                #else
                DEBUG_PRINT("Sending Frame\n\r");
                #endif
           // }
            adcFrameReady = 0;
        }
        
        // Parse a command if available
        if (commandReady) {
            parseCommand(command);
            commandReady = 0;
        }
    }
    return 0;
}

void parseCommand(char *cmd) {
    char *param = cmd + 1;
    uint32 temp;
    
    if (*param == 'A') {
        DEBUG_PRINT("ADC");
        ++param;
        while (*param != '#') {
            switch (*param++) {
                case 'A': // Start
                    DEBUG_PRINT(" Start");
                    startADC();
                    ADC_SetPower(ADC__HIGHPOWER);
                    break;
                case 'F': // Samples per frame
                    DEBUG_PRINT(" SPF");
                    sscanf(param, "%ld", &temp);
                    adcFrameResize(temp);
                    break;
                case 'P': // Frames per second
                    DEBUG_PRINT(" FPS");
                    sscanf(param, "%ld", &temp);
                    if(temp && temp <= 255) // Crappy attempt at an upper limit
                        TIMER_DMA_WritePeriod(TIMER_DMA_CLOCK_FREQ / temp);
                     else
                        DEBUG_PRINT(" FPS too large");
                    break;
                case 'R': // Resolution
                    DEBUG_PRINT(" Res");
                    sscanf(param, "%ld", &temp);
                    changeRes(temp);
                    break;
                case 'S': // Samples per second
                    DEBUG_PRINT(" SPS");
                    sscanf(param, "%ld", &temp);
                    changeSPS(temp);
                    break;
                case 'Z': // Stop
                    DEBUG_PRINT(" Stop");
                    stopADC();
                    break;
                default:  // Unexpected parameter
                    DEBUG_PRINT(" Unknown");
                    break;
            }
            param = strpbrk(param, ADC_PARAMS);
        }
        DEBUG_PRINT("\n\r");
    }
    else if (*param == 'D') {
        DEBUG_PRINT("DAC");
        ++param;
        while (*param != '#') {
            switch (*param++) {
                case 'A': // Start
                    DEBUG_PRINT(" Start");
                    regenerateWave();
                    break;
                case 'D': // Duty cycle
                    DEBUG_PRINT(" Duty");
                    uint dutyTemp;
                    sscanf(param, "%d", &dutyTemp);
                    if (dacDuty > 100 || wavetype != 'Q') {
                        DEBUG_PRINT(" Invalid duty");
                    } else {
                       dacDuty = dutyTemp;
                       regenerateWave();
                    }
                    break;
                case 'F': // Frequency
                    DEBUG_PRINT(" Freq"); 
                    uint32 temp_freq;
                    sscanf(param, "%lu", &temp_freq);
                    if (temp_freq > 25000) {
                        DEBUG_PRINT(" Invalid frequency");
                    } else if (temp_freq < 62) {
                        dacSample = 24000;
                        DAC_Clock_SetDividerValue(dacSample);
                        sample_size = 2000 / temp_freq;
                        regenerateWave();
                    } else {
                        dacSample = 192;
                        DAC_Clock_SetDividerValue(dacSample);
                        sample_size = DEFAULT_DAC_SAMPLE_RATE / temp_freq;
                        regenerateWave();
                    }
                    break;
                case 'O': // Offset
                    DEBUG_PRINT(" Offset");
                    float temp_offset;
                    sscanf(param, "%f", &temp_offset);
                    // Make sure it is a valid value
                    if (temp_offset < 0 || temp_offset > 4.0) {
                       DEBUG_PRINT(" Invalid offset");
                    }
                    else {
                       // Changes offset to a value between 0 to 250
                       dacOffset = floor( temp_offset / 4.0 * 250 ) - DEFAULT_DAC_OFFSET;
                       regenerateWave();
                    }
                    break; 
                    
                case 'V': // Peak to Peak Voltage / Amplitude
                    DEBUG_PRINT(" VPP");
                    float temp_VPP;
                    sscanf(param, "%f", &temp_VPP);
                    // Make sure it is a valid value
                    if (temp_VPP < 0 || temp_VPP > 4.0) {
                        DEBUG_PRINT(" Invalid VPP");
                    }
                    else {
                        // Do stuff to change the VPP
                        dacVPP = floor( temp_VPP / 4.0 * 125 );
                        regenerateWave();
                    }
                    break;
                    
                case 'W': // Waveform
                    DEBUG_PRINT(" Wave");
                    wavetype = *(param++);
                    regenerateWave();
                    break;
                case 'Z': // Stop
                    DEBUG_PRINT(" Stop");
                    stopDAC();
                    break;
                default:  // Unexpected parameter
                    DEBUG_PRINT(" Unknown");
                    break;
            }
            param = strpbrk(param, DAC_PARAMS);
        }
        DEBUG_PRINT("\n\r");
    }
    else if (strcmp(command, PC_DISCONNECT) == 0) {
        // Perform Software reset, good as new
        CySoftwareReset();
    }
    else { // Unspecified command
        DEBUG_PRINT("Unspecified command\n\r");
    }
}

void regenerateWave()
{
    int i;
    int temp;
    float phase;
    stopDAC();   
    switch (wavetype) {
        case 'I': // Sine
            for(i = 0; i < sample_size; i++) {
                temp = sine[(int)((i /(double)sample_size) * 4000)];
                temp = (temp/125.0) * dacVPP;
                wave[i] = (temp > 250)?250u:(temp < 0)?0u:temp;
            }
            break;
        case 'Q': // Square
            for(i = 0; i < sample_size; i++) {
                wave[i] = (i < (int)((dacDuty / 100.0)* sample_size))? 250u : 0u;
            }
            break;
        case 'T': // Triangle
            for(i = 0; i < sample_size; i++)
            {
                wave[i] = triangle[(int)((i /(double)sample_size) * 4000)];
            }
            break;
        case 'W': // Sawtooth
            for(i = 0;i< sample_size;i++)
            {
                wave[i] = sawtooth[(int)((i /(double)sample_size) * 4000)];
            }
            break;
        default:
            // Bad parameter
            DEBUG_PRINT(" Invalid waveform");
            break;
    }
    DAC_1_Wave1Setup(wave, sample_size);
    startDAC();
}


void startADC() {
    if (!adcOn) {
        ADC_StartConvert();
        TIMER_DMA_Start();
        adcOn = 1;
        CyDmaChEnable(DMA_ADC_MEM_Chan, 1);
    }
}

/* 
   Steps to make it safe.
   1. Stop the timer
   2. Wait for the DMA to finish
   3. Stop the ADC
*/
void stopADC() {
    uint8 state;
    
    if (adcOn) {
        TIMER_DMA_Stop();
        do {
            CyDmaChStatus(DMA_ADC_MEM_Chan, NULL, &state);
        }while (state & 0x03);
        //CyDmaChDisable(DMA_ADC_MEM_Chan); // May not need this. No idea.
        //ADC_Stop();
        adcOn = 0;
    }
}

void startDAC() {
    if (!dacOn) 
    {
//        MUX_DAC_FastSelect(ms);
//        Control_DAC_Write(ws);
        DAC_1_Start();
        //DAC_2_Start();
        dacOn = 1;
    }
}

void stopDAC() {
    if (dacOn) {
//        MUX_DAC_DisconnectAll();
        DAC_1_Stop();
        //DAC_2_Stop();
        dacOn = 0;
    }
}

void changeSPS(uint32 sps) {
    int restoreAdc = adcOn;
    int i;
    
    // Don't have 10- or 12-bit implemented yet *****************************
    if (adcRez != 12) {
        DEBUG_PRINT("Not implemented for 8- or 10-bit yet. Rejecting request.\n\r");
        return;
    }
    
    // Make sure it is a valid value
    for (i = 0; i < 6; i++) {
        if (adcSPSValues[i] == sps)
           break;
    }
    
    if (i == 6) {
        DEBUG_PRINT("Invalid SPS. Rejecting request.\n\r");
        return;
    }
        
    // Stop the ADC. Safety first, kids.
    stopADC();
    
    // <i> should now point to the table entry for the SPS
    // Set the clock divider
    if (adcRez == 12)
        ADC_Clock_SetDividerValue(adcDiv12Bit[i]);
    else {
        return;
    }
    
    // Set the counter period
    if (adcRez == 12){
        SPS_Divider_Counter_WritePeriod(adcCount12Bit[i]);
    }
    else {
        return;
    }
    
    // Set the mux control register
    if (adcRez == 12) {
        if (adcCount12Bit[i] == 1)
            SPS_Divider_Control_Reg_Write(0x00);
        else
            SPS_Divider_Control_Reg_Write(0xFF);
            
        SPS_Divider_Control_Reg_SaveConfig();
    }
    else {
        return;
    }
    
    adcSPS = sps;
    
    // Restart if necessary
    if (restoreAdc)
        startADC();
}

void changeRes(int res) {
    int restoreADC = adcOn;
    
    // Make sure it is a valid value
    if ((res != 12 && res != 10 && res != 8) || (unsigned)res == adcRez) {
        DEBUG_PRINT(" Invalid resolution");
        return;
    }
    
    // Play safely
    stopADC();
    
    // Check to see if changing between incompatible res'
    if (res == 8 || adcRez == 8) {
        DMA_ADC_MEM_Destruct();
        
        // Resize the frame and DMA settings
       // DMA_ADC_MEM_BYTES_PER_BURST = res == 8 ? 1 : 2;
        adcFrameResize(adcFrameSize);
        
        // Reconfigure the DMA with new settings
        DMA_ADC_MEM_Config();
    }
    
    // Finally change the resolution
    ADC_SetResolution(res);
    
    // Turn the lights back on
    if (restoreADC)
        startADC();
}

void adcFrameResize(int newSize) {
   // free(adcFrame);
        
    // Make sure new size doesn't request more bytes than the DMA can handle
    if (DMA_ADC_MEM_BYTES_PER_BURST * newSize > MAX_DMA_TRANSFER_SIZE) {
        adcFrameSize = MAX_DMA_TRANSFER_SIZE / DMA_ADC_MEM_BYTES_PER_BURST;
        DEBUG_PRINT("Sloppy programming. Data size * frame size must be ");
        DEBUG_PRINT("less than 4095 bytes.\r\nResized to max frame size.\r\n");
    }
    else
        adcFrameSize = newSize;
    
    //adcFrame = malloc(DMA_ADC_MEM_BYTES_PER_BURST * adcFrameSize);
}

void UART_RXISR_ExitCallback() {
    char c;
    
    CYGlobalIntDisable;

    // Build the command if no other command is pending
    // Need error checking for command greater than 32 chars**************************
    while (UART_GetRxBufferSize() && !commandReady) {
        c = UART_GetChar();
        if (rxBufLen || c == '#') { // Filters out random bytes
            rxBuffer[rxBufLen] = c;
            if (rxBufLen++ && c == '#') { // End packet
                commandReady = 1;
                strncpy(command, rxBuffer, rxBufLen);
                command[rxBufLen] = 0;
                rxBufLen = 0;
            }
        }
        else {
            while (UART_GetRxBufferSize())
               UART_GetChar();
            rxBufLen = 0;
            DEBUG_PRINT("Random bytes\n\r");
        }
    }
    
    // Check for error with UART module
    if (UART_ReadRxStatus() & (UART_RX_STS_OVERRUN | UART_RX_STS_PAR_ERROR |
     UART_RX_STS_STOP_ERROR | UART_RX_STS_BREAK)) {
        // Maybe do something about it
        // Clear buffer and request resend
    }
        
    CYGlobalIntEnable;
}

// Used to reenable the ADC to MEM DMA so that another frame can be captured
CY_ISR(TIMER_DMA_INTER) {
    uint8 state = 0;
    cystatus status = 0;
    
    status = CyDmaChStatus(DMA_ADC_MEM_Chan, NULL, &state);
    
    // Want to make sure DMA and UART are complete before trying to reactivate it
    if (!adcFrameReady && status == CYRET_SUCCESS) {
        if (!(state & 0x03)) { // Only bottom two bits used
            CyDmaChEnable(DMA_ADC_MEM_Chan, 1);
            DEBUG_PRINT("DMA Reenabled\r\n");
        }
        else {
            DEBUG_PRINT("TIMER_DMA period too small\r\n");
        }
    }
    else {
        DEBUG_PRINT("Error reading DMA status.\r\n");
    }
}

// Used to notify Main that a frame is ready for transmission
CY_ISR(DMA_FRAME_INTER) {
    DEBUG_PRINT("Frame Captured\r\n");
    adcFrameReady = 1;
}

/*  Code created by the DMA Wizard. Initializes the DMA to transfer ADC_FRAME_SIZE samples
 *  to the array adcFrame. After one frame capture it disables the channel and waits to be
 *  reenabled.
 */
void DMA_ADC_MEM_Config() {
    DMA_ADC_MEM_Chan = DMA_ADC_MEM_DmaInitialize(DMA_ADC_MEM_BYTES_PER_BURST, DMA_ADC_MEM_REQUEST_PER_BURST, 
     HI16(DMA_ADC_MEM_SRC_BASE), HI16(DMA_ADC_MEM_DST_BASE));
    DMA_ADC_MEM_TD[0] = CyDmaTdAllocate();
    CyDmaTdSetConfiguration(DMA_ADC_MEM_TD[0], 2 * adcFrameSize, CY_DMA_DISABLE_TD,
     DMA_ADC_MEM__TD_TERMOUT_EN | TD_INC_DST_ADR);
    CyDmaTdSetAddress(DMA_ADC_MEM_TD[0], LO16((uint32)ADC_SAR_WRK0_PTR), LO16((uint32)adcFrame));
    CyDmaChSetInitialTd(DMA_ADC_MEM_Chan, DMA_ADC_MEM_TD[0]);
}

/*
   Gets rid of the DMA channel and TD, most-likely to update it for some change.
   User needs to make sure DMA is stopped before attempting to call this function.
*/
void DMA_ADC_MEM_Destruct() {
    DMA_ADC_MEM_DmaRelease();
    CyDmaTdFree(DMA_ADC_MEM_TD[0]);
}